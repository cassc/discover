Discover -- a source code static analyzer
=====================================================

*Copyright (c) 2020-2021 Singapore Blockchain Innovation Program.*


# Compiling Discover

## Prerequisites

Preferably Ubuntu / Linux Mint. The following commands are tested and work well
with Linux Mint / Ubuntu 20.

### Tools and libraries

- LLVM and Clang 12

  + Install from Linux repositories:

    ``` sh
    # Ubuntu, Linux Mint
    sudo apt-get install llvm-12 llvm-12-dev clang-12 libclang-12-dev

    # Arch Linux, Manjaro
    sudo pacman -S llvm12 clang12
    ```

  + If LLVM and Clang cannot be installed automatically, then in Ubuntu-based
    operating systems, user can download a pre-built LLVM and Clang version 12
    from the [LLVM GitHub Releases](https://github.com/llvm/llvm-project/releases), and extract it to `$HOME/llvm/llvm-12`.

    Then, run the following commands to update the environment variables:

    ``` sh
    # Assume that LLVM + Clang 12 binaries are stored at $HOME/llvm/llvm-12/
    export PATH=$HOME/llvm/llvm-12/bin:$PATH
    export LD_LIBRARY_PATH=$HOME/llvm/llvm-12/lib:$LD_LIBRARY_PATH
    ```

  + Otherwise, LLVM and Clang 12 can be downloaded and built from source code.
    To do this, download source code of LLVM 12 from the [LLVM GitHub
    Releases](https://github.com/llvm/llvm-project/releases) and extract it to `$HOME/llvm/src/llvm-project-12/`:

    ``` sh
    # Assume that LLVM 12 source code is stored at $HOME/llvm/src/llvm-project/
    mkdir -p $HOME/llvm/llvm-12
    cd $HOME/llvm/src/llvm-project/
    mkdir -p build; cd build
    cmake ../llvm -DLLVM_ENABLE_PROJECTS=clang -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=$HOME/llvm/llvm-12 -Wno-dev -G Ninja
    ninja
    ninja install
    export PATH=$HOME/llvm/llvm-12/bin:$PATH
    export LD_LIBRARY_PATH=$HOME/llvm/llvm-12/lib:$LD_LIBRARY_PATH
    ```

- CMake, zlib, libedit, z3

  ``` sh
  # Ubuntu, Linux Mint
  sudo apt-get install cmake zlib1g-dev libedit-dev z3

  # Arch Linux, Manjaro
  sudo pacman -S cmake zlib z3 libedit
  ```

### Gollvm for compiling Hyperledger Fabric smart contracts

- Install ninja-build

  ``` sh
  sudo apt-get install clang-12 ninja-build
  ```

- Run the following instructions to install `gollvm`.

  ``` sh
  export LLVMDIR=$HOME/llvm                   # path to LLVM directory

  mkdir -p $LLVMDIR/src
  cd $LLVMDIR/src
  git clone https://github.com/llvm/llvm-project.git llvm-project-gollvm

  export LLVMGOLLVM=$LLVMDIR/src/llvm-project-gollvm
  cd $LLVMGOLLVM/llvm/tools
  git clone https://go.googlesource.com/gollvm

  cd $LLVMGOLLVM/llvm/tools/gollvm
  git clone https://go.googlesource.com/gofrontend

  cd $LLVMGOLLVM/llvm/tools/gollvm/libgo
  git clone https://github.com/libffi/libffi.git
  git clone https://github.com/ianlancetaylor/libbacktrace.git
  ```
- Checkout the following commit for LLVM-11-compatible version:

  (TODO: update Gollvm tutorial to LLVM 12 )

  ``` sh
  # Git revisions for working with LLVM 11
  # LLVM: 43ff75f2c3feef64f9d73328230d34dac8832a91
  # gollvm: 44a7a475cfd3b871b7a5a0941b8ab1ea9d489adc
  # gofrontend: be0d2cc2df9f98d967c242594838f86362dae2e7
  # libbacktrace: 5a99ff7fed66b8ea8f09c9805c138524a7035ece
  # libffi: 737d4faa00d681b4c758057f67e1a02d813d01c2

  # update LLVM to 11.1.0-rc3
  cd $LLVMGOLLVM
  git checkout 1fdec59bffc11ae37eb51a1b9869f0696bfd5312

  cd $LLVMGOLLVM/llvm/tools/gollvm
  git checkout 44a7a475cfd3b871b7a5a0941b8ab1ea9d489adc

  cd $LLVMGOLLVM/llvm/tools/gollvm/gofrontend
  git checkout be0d2cc2df9f98d967c242594838f86362dae2e7

  cd $LLVMGOLLVM/llvm/tools/gollvm/libgo/libffi
  git checkout 737d4faa00d681b4c758057f67e1a02d813d01c2

  cd $LLVMGOLLVM/llvm/tools/gollvm/libgo/libbacktrace
  git checkout 5a99ff7fed66b8ea8f09c9805c138524a7035ece
  ```

- Compiling Gollvm

  ``` sh
  mkdir -p $LLVMDIR/gollvm
  export GOLLVMDIR=$LLVMDIR/gollvm

  mkdir -p $LLVMGOLLVM/build
  cd $LLVMGOLLVM/build

  # IMPORTANT: make sure to use clang and clang++ version 11
  CC=clang CXX=clang++ \
           cmake ../llvm -DCMAKE_INSTALL_PREFIX=$GOLLVMDIR \
           -DLLVM_ENABLE_BINDINGS=OFF -DLLVM_ENABLE_RTTI=ON \
           -DCMAKE_BUILD_TYPE=Release -DLLVM_USE_LINKER=gold -G Ninja

  ninja gollvm
  ninja install # or ninja install-gollvm
  ```

  After that, the gollvm compiler is installed to `$GOLLVMDIR/bin`.

- Caputure LLVM bitcode generated by Gollvm: see `README.md` of
  `llvm-project/llvm/tools/gollvm`.

### OCaml for development

- Currently, we are using 4.12.0, or newer.

  ``` sh
  sudo apt-get install opam
  opam init
  opam switch create 4.12.0
  eval $(opam env)
  opam install core unix str ocamlgraph fileutils yaml ezjsonm \
               llvm llvm.target llvm.bitreader llvm.bitwriter llvm.irreader
  ```

## Compilation

- Download source code:

  ``` sh
  export WORKDIR=$HOME/workspace           # or any other working directory
  cd $WORKDIR
  git clone https://github.com/sbip-sg/discover-analyzer
  git clone https://github.com/sbip-sg/llvm-normalizer
  ```

- Compile `discover`:

  ``` sh
  cd $WORKDIR/discover-analyzer
  make
  ```

- Compile `llvm-normalizer`:

  ``` sh
  cd $WORKDIR/llvm-normalizer
  mkdir -p build; cd build; cmake ..
  make
  ```

- After that, copy the file `llvm-normalizer/build/normalizer` to the folder
  `discover-analyzer`:

  ``` sh
  cp $WORKDIR/llvm-normalizer/build/normalizer $WORKDIR/discover-analyzer/
  ```

# Running Discover

- Run pointer analysis on C program:

  ``` sh
  cd $WORKDIR/discover-analyzer
  ./discover --clang-option "-I ./lib/discover" --dfa-pointer --dfa-inter \
             examples/c/field-read.c
  ```

# Contributing to our Discover project

## Current contributors

- [Ta Quang Trung](https://github.com/taquangtrung/)
- [Ren Kunpeng](https://github.com/kunpengren)
- [Trinh Ngoc Khanh](https://github.com/tnkhanh)
- [Huang Lung-Chen](https://github.com/lung21)

## Want to contribute to our project?

- Please create issues or pull requests to help us improve our tool! :)
