Discover -- Compilation and Installation
=======================================================

Copyright (c) 2020-2021 Singapore Blockchain Innovation Program.

# Prerequisites

Preferably Ubuntu / Linux Mint. The following commands are tested and work well
with Linux Mint / Ubuntu 20.

## Tools and libraries

- Ninja-build, z3

  ``` sh
  sudo apt-get install ninja-build, z3
  ```

- LLVM and Clang 13

  + Install from Linux repositories:

    ``` sh
    IMPORTANT: to be updated when LLVM 13 is officially released
    # Ubuntu, Linux Mint
    # sudo apt-get install llvm-13 llvm-13-dev clang-13 libclang-13-dev

    # Arch Linux, Manjaro
    # sudo pacman -S llvm13 clang13
    ```

  + Or, if LLVM and Clang cannot be installed automatically, then download
    prebuilt LLVM and Clang from the [LLVM GitHub Releases](https://github.com/llvm/llvm-project-13/releases), and extract it
    to `$HOME/llvm/llvm-13` (or any other custom directory):

    ``` sh
    # TODO: Revise the followings when LLVM 13 released.
    # Assume that LLVM + Clang 13 binaries are stored at $HOME/llvm/llvm-13/
    # export PATH=$HOME/llvm/llvm-13/bin:$PATH
    # export LD_LIBRARY_PATH=$HOME/llvm/llvm-13/lib:$LD_LIBRARY_PATH
    ```

  + Otherwise, LLVM and Clang 13 can be built from the branch `sbip-llvm-13` of
    our custom [LLVM 13](https://github.com/sbip-sg/llvm-project), and install to `$HOME/llvm/llvm-13`:

    ``` sh
    # Prepare installation folder
    mkdir -p $HOME/llvm/llvm-13

    # Build LLVM
    mkdir -p $HOME/llvm/src/
    git clone https://github.com/sbip-sg/llvm-project llvm-project-13
    cd llvm-project-13
    git checkout sbip-llvm-13

    mkdir -p build; cd build
    cmake ../llvm -DCMAKE_INSTALL_PREFIX=$HOME/llvm/llvm-13 \
          -DLLVM_ENABLE_PROJECTS=clang -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_BINDINGS=ON -Wno-dev -G Ninja
    ninja

    # Install LLVM
    ninja install

    # Update environment
    export PATH=$HOME/llvm/llvm-13/bin:$PATH
    export LD_LIBRARY_PATH=$HOME/llvm/llvm-13/lib:$LD_LIBRARY_PATH
    ```

## Gollvm for compiling Hyperledger Fabric smart contracts

- Run the following instructions to install `gollvm`.

  ``` sh
  export LLVMDIR=$HOME/llvm                   # path to LLVM directory

  # This step may be skip if our custom LLVM 13 repository already downloaded
  mkdir -p $HOME/llvm/src/
  git clone https://github.com/sbip-sg/llvm-project llvm-project-13
  cd llvm-project-13
  git checkout sbip-llvm-13

  # Download source code and libraries of gollvm
  export LLVMPROJECT=$LLVMDIR/src/llvm-project-13
  cd $LLVMPROJECT/llvm/tools
  git clone https://go.googlesource.com/gollvm

  cd $LLVMPROJECT/llvm/tools/gollvm
  git clone https://go.googlesource.com/gofrontend

  cd $LLVMPROJECT/llvm/tools/gollvm/libgo
  git clone https://github.com/libffi/libffi.git
  git clone https://github.com/ianlancetaylor/libbacktrace.git
  ```
- Checkout the following commit for LLVM-13 compatible version:

  ``` sh
  # Git revisions for working with LLVM 11
  # LLVM: 43ff75f2c3feef64f9d73328230d34dac8832a91
  # gollvm: 44a7a475cfd3b871b7a5a0941b8ab1ea9d489adc
  # gofrontend: be0d2cc2df9f98d967c242594838f86362dae2e7
  # libbacktrace: 5a99ff7fed66b8ea8f09c9805c138524a7035ece
  # libffi: 737d4faa00d681b4c758057f67e1a02d813d01c2

  # update LLVM to 11.1.0-rc3
  cd $LLVMPROJECT
  git checkout 1fdec59bffc11ae37eb51a1b9869f0696bfd5312

  cd $LLVMPROJECT/llvm/tools/gollvm
  git checkout 44a7a475cfd3b871b7a5a0941b8ab1ea9d489adc

  cd $LLVMPROJECT/llvm/tools/gollvm/gofrontend
  git checkout be0d2cc2df9f98d967c242594838f86362dae2e7

  cd $LLVMPROJECT/llvm/tools/gollvm/libgo/libbacktrace
  git checkout d0f5e95a87a4d3e0a1ed6c069b5dae7cbab3ed2a

  cd $LLVMPROJECT/llvm/tools/gollvm/libgo/libffi
  git checkout 737d4faa00d681b4c758057f67e1a02d813d01c2

  cd $LLVMPROJECT/llvm/tools/gollvm/libgo/libbacktrace
  git checkout 5a99ff7fed66b8ea8f09c9805c138524a7035ece
  ```

- Compiling Gollvm

  ``` sh
  mkdir -p $LLVMDIR/gollvm
  export GOLLVMDIR=$LLVMDIR/gollvm

  mkdir -p $LLVMPROJECT/build
  cd $LLVMPROJECT/build

  # IMPORTANT: make sure to use clang and clang++ version 11
  CC=clang CXX=clang++ \
           cmake ../llvm -DCMAKE_INSTALL_PREFIX=$GOLLVMDIR \
           -DLLVM_ENABLE_BINDINGS=ON -DLLVM_ENABLE_RTTI=ON \
           -DLLVM_ENABLE_PROJECTS=clang -DCMAKE_BUILD_TYPE=Release \
           -DLLVM_USE_LINKER=gold -Wno-dev -G Ninja

    <!-- cmake ../llvm -DCMAKE_INSTALL_PREFIX=$HOME/llvm/llvm-13 \ -->
    <!--       -DLLVM_ENABLE_PROJECTS=clang -DCMAKE_BUILD_TYPE=Release \ -->
    <!--       -DLLVM_ENABLE_BINDINGS=ON -Wno-dev -G Ninja -->

  ninja gollvm
  ninja install # or ninja install-gollvm
  ```

  After that, the gollvm compiler is installed to `$GOLLVMDIR/bin`.

- Capture LLVM bitcode generated by Gollvm: see `README.md` of
  `llvm-project-13/llvm/tools/gollvm`.

## OCaml for development

- Currently, we are using 4.12.0, or newer.

  ``` sh
  sudo apt-get install opam
  opam init
  opam switch create 4.12.0
  eval $(opam env)
  opam install core unix str ocamlgraph fileutils yaml ezjsonm \
               llvm llvm.target llvm.bitreader llvm.bitwriter llvm.irreader
  ```

- Manually configure LLVM 13 bindings to the opam install directory:

  ``` sh
  opam uninstall llvm
  cd $HOME/.opam/4.12.0/lib
  mkdir -p llvm/static
  cp ocaml/llvm/* llvm/static
  cp ocaml/llvm/* llvm
  ```

# Compilation

- Download source code:

  ``` sh
  export WORKDIR=$HOME/workspace           # or any other working directory
  cd $WORKDIR
  git clone https://github.com/sbip-sg/discover-analyzer
  git clone https://github.com/sbip-sg/llvm-normalizer
  ```

- Update environmental variables, if you build LLVM-13 from source:

  ``` sh
  PATH=$HOME/llvm/llvm-13/bin:$PATH
  LD_LIBRARY_PATH=$HOME/llvm/llvm-13/lib:$HOME/llvm/llvm-13/lib64:$LD_LIBRARY_PATH
  export LIBRARY_PATH=$HOME/llvm/llvm-13/lib:$HOME/llvm/llvm-13/lib64:$LIBRARY_PATH
  ```

- Compile `discover`:

  ``` sh
  cd $WORKDIR/discover-analyzer
  make
  ```

- Compile `llvm-normalizer`:

  ``` sh
  cd $WORKDIR/llvm-normalizer
  mkdir -p build; cd build; cmake ..
  make
  ```

- After that, copy the file `llvm-normalizer/build/normalizer` to the folder
  `discover-analyzer`:

  ``` sh
  cp $WORKDIR/llvm-normalizer/build/normalizer $WORKDIR/discover-analyzer/
  ```
